---
title: "Evaluating Necessity for UR Stratification"
output: pdf_document
---

```{r setup, include=FALSE}
# ENTER COUNTRY OF INTEREST -----------------------------------------------
# Please capitalize the first letter of the country name and replace " " in the country name to "_" if there is.
country <- 'Malawi'

# Load libraries -----------------------------------------------
library(INLA)
library(tidyverse)
library(openxlsx)
library(locfit)
options(pillar.sigfig=6)

# Load info -----------------------------------------------
code.path <- rstudioapi::getActiveDocumentContext()$path
code.path.splitted <- strsplit(code.path, "/")[[1]]

home.dir <- paste(code.path.splitted[1: (length(code.path.splitted)-2)], collapse = "/")
data.dir <- paste0(home.dir,'/Data/',country) # set the directory to store the data
res.dir <- paste0(home.dir,'/Results/',country) # set the directory to store the results (e.g. fitted R objects, figures, tables in .csv etc.)
info.name <- paste0(country, "_general_info.Rdata")
load(file = paste0(home.dir,'/Info/',info.name, sep='')) # load the country info

# Load cluster data, sampling proportions, and direct estimates  ----------------------------------------------------------
sampling_info <- read.xlsx(paste0(home.dir,'/Data/UR_sampling/',country.abbrev,'_urbhh.xlsx'))

setwd(paste0(data.dir))
load(paste0(country,'_cluster_dat.rda'),
     envir = .GlobalEnv)

setwd(paste0(res.dir))
load(paste0('Direct/U5MR/',country, '_direct_natl_yearly_u5.rda'))
load(paste0('Direct/U5MR/',country, "_res_natl_yearly_u5_SmoothedDirect.rda"))

## Calculate Admin 1 population proportions by region (for aggregation) ------------------------------------------------------

## Admin 1
weight.region.adm1.u5 <- expand.grid(region = sort(unique(mod.dat$admin1.name)), years = beg.year:max(survey_years))
weight.region.adm1.u5$proportion <- NA

for (i in 1:nrow(weight.region.adm1.u5)) {
  numerator <- sum(mod.dat$total[mod.dat$admin1.name==weight.region.adm1.u5[i,1] & mod.dat$years==weight.region.adm1.u5[i,2]])
  denominator <- sum(mod.dat$total[mod.dat$years==weight.region.adm1.u5[i,2]])
  weight.region.adm1.u5[i, "proportion"] <- numerator/denominator
}

## Admin 1 x UR
weight.region.adm1.ur.u5 <- expand.grid(region = sort(unique(mod.dat$admin1.name)), strata = c('rural','urban'), years = beg.year:max(survey_years))
weight.region.adm1.ur.u5$proportion <- NA
for (i in 1:nrow(weight.region.adm1.ur.u5)) {
  numerator <- sum(mod.dat$total[mod.dat$admin1.name==weight.region.adm1.ur.u5[i,1] & mod.dat$years==weight.region.adm1.ur.u5[i,3] & mod.dat$urban==weight.region.adm1.ur.u5[i,2]])
  denominator <- sum(mod.dat$total[mod.dat$years==weight.region.adm1.ur.u5[i,3]])
  weight.region.adm1.ur.u5[i, "proportion"] <- numerator/denominator
}


```

```{r, include=FALSE}
# Fit models  ----------------------------------------------------------
## Model w/o urban/rural  ----------------------------------------------------------
mod1 <- inla(formula=Y ~ -1 + admin1.name + f(years,model='iid'), family='betabinomial', data=mod.dat, Ntrials = total,
             control.compute= list(config=T), control.inla = list(strategy = 'adaptive',int.strategy = 'auto'))
# draw samples from posterior
select <- as.list(rep(0,length(unique(mod.dat$admin1.name))+1))
names(select) <- mod1$misc$configs$contents$tag[2:(length(select)+1)]
nsim <- 1000
mod1.samples <- inla.posterior.sample(n=nsim, result=mod1,intern=T, selection=select)

# reformat samples to prepare for aggregation
num.years <- length(unique(mod.dat$years))
num.admin1 <- length(unique(mod.dat$admin1.name))
fields <- sort(unique(mod.dat$admin1.name))
sample.restruct <- matrix(NA,nsim,num.years*num.admin1)
colnames(sample.restruct) <- rep(paste0(' '),ncol(sample.restruct))
for(j in 1:num.admin1){
  for(i in 1:nsim){
    for(k in 1:num.years){
      sample.restruct[i,(j-1)*num.years+k] <- mod1.samples[[i]]$latent[num.years + j,] + mod1.samples[[i]]$latent[k,]
      colnames(sample.restruct)[(j-1)*num.years+k] <- paste0(fields[j],':',k)
    }
  }
}
mod1.draws <- expit(sample.restruct)
mod1.hazards <- 1-(1-mod1.draws)^60

mod1.res <- t(apply(mod1.hazards,2,function(x){
    c(median(x),quantile(x,0.025),quantile(x,0.975))
  }))
colnames(mod1.res)[1] <- 'median'
mod1.res <- as.data.frame(mod1.res)

# aggregate admin-level samples to national
mod1.res$year <- unique(mod.dat$years)
mod1.res <- mod1.res[order(mod1.res$year),]
mod1.res <- cbind(mod1.res,weight.region.adm1.u5)
mod1.agg <- mod1.res %>% group_by(year) %>% summarise(sum(median*proportion))
colnames(mod1.agg) <- c('years','mod1_median')
mod1.agg$years <- beg.year:max(survey_years)


## Model w urban intercept  ----------------------------------------------------------
mod2 <- inla(formula=Y ~ -1 + admin1.name + urban+ f(years,model='iid'), family='betabinomial', data=mod.dat, Ntrials = total,
             control.compute= list(config=T), control.inla = list(strategy = 'adaptive',int.strategy = 'auto'))
# draw samples from posterior
select <- as.list(rep(0,length(unique(mod.dat$admin1.name))+2))
names(select) <- mod2$misc$configs$contents$tag[2:(length(select)+1)]
nsim <- 1000
mod2.samples <- inla.posterior.sample(n=nsim, result=mod2,intern=T, selection=select)

# reformat samples to prepare for aggregation
num.years <- length(unique(mod.dat$years))
num.admin1 <- length(unique(mod.dat$admin1.name))
fields <- sort(unique(mod.dat$admin1.name))
sample.restruct <- matrix(NA,nsim,2*num.years*num.admin1)
colnames(sample.restruct) <- rep(paste0(' '),ncol(sample.restruct))
for(j in 1:num.admin1){
  for(i in 1:nsim){
    for(k in 1:num.years){
      sample.restruct[i,(j-1)*num.years+k] <- mod2.samples[[i]]$latent[num.years + j,] + mod2.samples[[i]]$latent[k,] + tail(mod2.samples[[i]]$latent,1)
      sample.restruct[i,num.years*num.admin1+(j-1)*num.years+k] <- mod2.samples[[i]]$latent[num.years + j,] + 
                                                          mod2.samples[[i]]$latent[k,]
      colnames(sample.restruct)[(j-1)*num.years+k] <- paste0(fields[j],':rural:',k)
      colnames(sample.restruct)[num.years*num.admin1+(j-1)*num.years+k] <- paste0(fields[j],':urban:',k)
    }
  }
}
mod2.draws <- expit(sample.restruct)
mod2.hazards <- 1-(1-mod2.draws)^60

mod2.res <- t(apply(mod2.hazards,2,function(x){
  c(median(x),quantile(x,0.025),quantile(x,0.975))
}))
colnames(mod2.res)[1] <- c('median')
mod2.res <- as.data.frame(mod2.res)

# aggregate admin-level samples to national
mod2.res$year <- unique(mod.dat$years)
mod2.res <- mod2.res[order(mod2.res$year),]
mod2.res <- cbind(mod2.res,weight.region.adm1.ur.u5)
mod2.agg <- mod2.res%>% group_by(year) %>% summarise(sum(median*proportion))
colnames(mod2.agg) <- c('years','mod2_median')
mod2.agg$years <- beg.year:max(survey_years)

## Model w urban interaction  ----------------------------------------------------------
mod3 <- inla(formula=Y ~ -1 + admin1.name + urban + admin1.name*urban + f(years,model='iid'), family='betabinomial', data=mod.dat, Ntrials = total,
             control.compute= list(config=T), control.inla = list(strategy = 'adaptive',int.strategy = 'auto'))

## Comparing Models ----------------------------------------------------------

# BF for signficance of interecept
bf2v1 <- exp(mod2$mlik[1] - mod1$mlik[1])
# BF for significance of intercepts and interactions
bf3v1 <- exp(mod3$mlik[1] - mod1$mlik[1])
# BF for significance of interactions
bf3v2 <- exp(mod3$mlik[1] - mod2$mlik[1])

```

### Country of Interest: `r country`

This report provides results which will help the team to decide whether it is necessary that we include urban-rural stratification in the Betabinomial models. There are two country-specific factors that must be evaluated to determine this: 1) over or under-sampling of urban households and 2) association between child mortality and type of household (urban or rural).

## 1) Urban/Rural Sampling

The plot below indicates the difference between the urban proportion of the sampled households and the actual urban proportion of households in the sampling frame. Each dot represents a different Admin1 region and the size of each dot is proportional to the total number of households in that region. The sum of absolute differences across all regions has been calculated, weighted by the total number of households in each region.  

Note that a dot above the line indicates urban oversampling in that region, whereas a dot below the line indicates urban undersampling.

```{r echo=FALSE}
tab <- sampling_info %>% filter(is.na(frame_prop) + is.na(sample_prop)==0) %>% mutate(diff = sample_prop-frame_prop,perc_diff = (sample_prop-frame_prop)/frame_prop,
                                                                              weighted_absdiff = f_total/sum(f_total)*abs(diff))
  if(sum(is.na(tab$f_urban) + is.na(tab$f_total) + is.na(tab$s_urban) + is.na(tab$s_total))==0){
    tab <- tab %>% mutate(chisq = ifelse(frame_prop>0 & frame_prop<1, (s_urban-(s_total*f_urban/f_total))^2/(s_total*frame_prop*(1-frame_prop)),0),
                          chisq2 = ifelse(frame_prop>0 & frame_prop<1 & sample_prop>frame_prop, (s_urban-(s_total*f_urban/f_total))^2/(s_total*frame_prop*(1-frame_prop)),0))
  }else{tab <- tab %>% mutate(chisq = NA,chisq2 = NA)}
                        
  if(-min(tab$diff)>0.29){
    plot.min <- min(tab$diff) - 0.01
  }else{plot.min <- -0.3}
  if(max(tab$diff)>0.29){
    plot.max <- max(tab$diff) + 0.01
  }else{plot.max <- 0.3}

  if(sum(is.na(tab$f_urban) + is.na(tab$f_total) + is.na(tab$s_urban) + is.na(tab$s_total))==0){
  tab %>% ggplot() + geom_point(aes(x=as.numeric(row.names(tab)),y=diff,size=sqrt(f_total))) + 
      ylab('Sample - Frame') + xlab('') + geom_hline(yintercept = 0) + 
      ggtitle(paste0('Urban sampling: ',country), paste0('Weighted Sum of Absolute Differences=',sum(tab$weighted_absdiff))) +
      ylim(c(plot.min,plot.max)) + xlim(c(0,nrow(tab)+2)) + theme(legend.position = 'none')
  }else{tab %>% ggplot() + geom_point(aes(x=as.numeric(row.names(tab)),y=diff)) + 
    ylab('Sample - Frame') + xlab('') + geom_hline(yintercept = 0) + 
      ggtitle(paste0('Urban sampling: ',country),paste0('Household/population count not available')) + ylim(c(plot.min,plot.max))}

```

\newpage

## 2) Association between mortality and urban/rural

We fit 3 simple Betabinomial models in INLA with the following covariate patterns and will compare them to address the association between mortality and urban/rural.

\begin{itemize}
\item Model 1: admin1 + f(years,model='iid')
\end{itemize}

```{r echo=FALSE}
summary(mod1)$fixed[,1:5]
```

\begin{itemize}
\item Model 2: admin1 + urban + f(years,model='iid')
\end{itemize}

```{r echo=FALSE}
summary(mod2)$fixed[,1:5]
```

\begin{itemize}
\item Model 3: admin1 + urban + admin1*urban + f(years,model='iid')
\end{itemize}

```{r echo=FALSE}
summary(mod3)$fixed[,1:5]
```

The Bayes factor for model 2 v. model 1 is `r bf2v1`.

The Bayes factor for model 3 v. model 1 is `r bf3v1`.

The Bayes factor for model 3 v. model 2 is `r bf3v2`.

The plot below compares the smoothed direct national estimates with aggregated national level estimates from each of the first two models. By comparing these national estimates, we can assess whether including the urban intercept provides more or less accurate estimates.

```{r echo=FALSE}
cols <- rainbow(length(survey_years)+2)

plot.max <- max(res.natl.yearly.u5$upper+.025, na.rm = T)

plot(NA, xlab = "Year", ylab = "U5MR",
     ylim = c(0, plot.max), xlim = c(beg.year, max(survey_years)),
     type = 'l', col = 'black', main = country)
for(survey in 1:length(survey_years)){
  tmp <- direct.natl.yearly.u5[direct.natl.yearly.u5$surveyYears == survey_years[survey],]
  lines(tmp$years,tmp$mean,
        col=cols[survey],lwd=1)
}
lines(res.natl.yearly.u5$years.num, res.natl.yearly.u5$median,
        col = 'black', lwd = 1)
lines(res.natl.yearly.u5$years.num, res.natl.yearly.u5$upper,
        col = 'black', lty = 2)
lines(res.natl.yearly.u5$years.num,res.natl.yearly.u5$lower, 
        col = 'black', lty = 2)
lines(mod1.agg$years, mod1.agg$mod1_median, col=cols[length(survey_years)+1],lwd=1)
lines(mod2.agg$years, mod2.agg$mod2_median, col=cols[length(survey_years)+2],lwd=1)
legend('topright', bty = 'n',
         col = c('black',cols),
         lwd = 2, legend = c("Smoothed Direct",paste0(survey_years,', Direct'),'1: No urban intercept','2: Urban intercept'))
```
